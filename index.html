<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <title>reveal.js</title>

        <link rel="stylesheet" href="dist/reset.css" />
        <link rel="stylesheet" href="dist/reveal.css" />
        <link rel="stylesheet" href="dist/theme/tokyo-night.css" />

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/tokyo-night.css" />
        <link rel="stylesheet" href="plugin/chalkboard/style.css" />
        <link rel="stylesheet" href="plugin/customcontrols/style.css" />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>Триггеры</h1>
                    <img
                        class="r-stretch"
                        src="https://ktkv-presentations.github.io/db-10"
                        data-type="qrcode" />
                </section>
                <section>
                    <section>
                        <h1>Триггер</h1>
                        <p>
                            объект базы данных, который автоматически выполняет
                            определённое действие в ответ на события
                        </p>
                        <pre><code class="sql">
CREATE TRIGGER имя_триггера
{BEFORE | AFTER | INSTEAD OF} {INSERT | UPDATE | DELETE}
ON таблица
[FOR EACH ROW]
BEGIN
  -- действия
END;
                        </code></pre>
                    </section>
                    <section>
                        <h1>Зачем нужны триггеры</h1>
                        <ul>
                            <li>Автоматизации процессов</li>
                            <li>Обеспечения целостности данных</li>
                            <li>Поддержки бизнес-логики</li>
                        </ul>
                        <br />
                        <br />
                        <div class="border-b">
                            <p>
                                В интернет-магазине триггер записывает изменения
                                в заказах в отдельную таблицу истории заказов
                            </p>
                        </div>
                    </section>
                </section>
                <section>
                    <section>
                        <h1>Событие</h1>
                        <div>
                            действие, которое вызывает выполнение триггера
                        </div>
                        <br />
                        <h4>Виды событий</h4>
                        <div class="grid grid-cols-2 gap-12">
                            <div>
                                <h4>INSERT</h4>
                                <p>когда в таблицу добавляется новая запись</p>
                            </div>
                            <div>
                                <h4>UPDATE</h4>
                                <p>
                                    когда в таблице изменяется существующая
                                    запись
                                </p>
                            </div>
                            <div class="col-span-2">
                                <h4>DELETE</h4>
                                <div>когда из таблицы удаляется запись</div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h1>Условие вызова</h1>
                        <div class="grid grid-cols-2 gap-12">
                            <div>
                                <h4>BEFORE</h4>
                                <p>
                                    перед добавлением, обновлением или удалением
                                    записи
                                </p>
                            </div>
                            <div>
                                <h4>AFTER</h4>
                                <p>после выполнения указанного события</p>
                            </div>
                            <div class="col-span-2">
                                <h4>INSTEAD OF</h4>
                                <div>
                                    заменяет выполнение указанного события
                                </div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h1>Тело триггера</h1>
                        <p>
                            SQL-код, который выполняется, когда триггер
                            срабатывает
                        </p>
                    </section>
                </section>
                <section>
                    <section data-auto-animate>
                        <h1>Части триггера</h1>
                        <h4>Событие</h4>
                        <pre><code data-id="code" data-trim data-noescape data-line-numbers="3" class="sql">
CREATE TRIGGER update_order_status
AFTER
INSERT ON orders
FOR EACH ROW
BEGIN
  UPDATE orders
  SET status = 'обработан'
  WHERE id = NEW.id;
END;
                    </code></pre>
                    </section>
                    <section data-auto-animate>
                        <h1>Части триггера</h1>
                        <h4>Условие вызова</h4>
                        <pre><code data-id="code" data-trim data-noescape data-line-numbers="2" class="sql">
CREATE TRIGGER update_order_status
AFTER
INSERT ON orders
FOR EACH ROW
BEGIN
  UPDATE orders
  SET status = 'обработан'
  WHERE id = NEW.id;
END;
                    </code></pre>
                    </section>
                    <section data-auto-animate>
                        <h1>Части триггера</h1>
                        <h4>Тело триггера</h4>
                        <pre><code data-id="code" data-trim data-noescape data-line-numbers="6-8" class="sql">
CREATE TRIGGER update_order_status
AFTER
INSERT ON orders
FOR EACH ROW
BEGIN
  UPDATE orders
  SET status = 'обработан'
  WHERE id = NEW.id;
END;
                    </code></pre>
                    </section>
                </section>
                <section>
                    <section data-auto-animate>
                        <h1>Синтаксис триггеров</h1>
                        <h2><code>CREATE TRIGGER</code></h2>
                        <p>
                            команда, используемая для создания нового триггера
                        </p>
                        <div class="border-b">
                            После ключевых слов CREATE TRIGGER указывается
                            уникальное имя триггера
                        </div>
                        <br />
                        <code class="sql">CREATE TRIGGER update_status</code>
                    </section>
                    <section data-auto-animate>
                        <h1>Синтаксис триггеров</h1>
                        <h2><code>ON таблица</code></h2>
                        <p>указывает, к какой таблице привязан триггер</p>
                        <br />
                        <code class="sql">ON orders</code>
                    </section>
                    <section data-auto-animate>
                        <h1>Синтаксис триггеров</h1>
                        <h2><code>FOR EACH ROW</code></h2>
                        <p>
                            указывает, что триггер должен срабатывать для каждой
                            строки, которая была затронута операцией
                            <code>INSERT</code>
                            ,
                            <code>UPDATE</code>
                            или
                            <code>DELETE</code>
                        </p>
                    </section>
                </section>
                <section>
                    <section data-auto-animate>
                        <h1>Недостатки триггеров</h1>
                        <h3>Проблемы с производительностью</h3>
                        <p>
                            Поскольку триггеры выполняются автоматически при
                            каждом изменении данных (вставке, обновлении или
                            удалении), они могут замедлить операции в таблицах с
                            большим количеством записей
                        </p>
                        <h4>Причины</h4>
                        <div class="grid grid-cols-2 gap-12">
                            <div class="border-b">
                                <h4>Избыточное количество триггеров</h4>
                            </div>
                            <div class="border-b">
                                <h4>Сложные операции в теле триггера</h4>
                            </div>
                        </div>
                    </section>
                    <section data-auto-animate>
                        <h1>Недостатки триггеров</h1>
                        <h3>Трудности с отладкой и тестированием</h3>
                        <p>
                            Отладка триггеров может быть сложной задачей, так
                            как они срабатывают автоматически при выполнении
                            определённых событий и не всегда явно видны в коде
                            приложения
                        </p>
                        <h4>Причины</h4>
                        <div class="grid grid-cols-2 gap-12">
                            <div class="border-b">
                                <h4>Скрытая логика</h4>
                            </div>
                            <div class="border-b">
                                <h4>Ошибки в коде триггера</h4>
                            </div>
                            <div class="border-b col-span-2">
                                <h4>Последовательность срабатывания</h4>
                            </div>
                        </div>
                    </section>
                    <section data-auto-animate>
                        <h1>Недостатки триггеров</h1>
                        <h3>Циклические зависимости</h3>
                        <p>
                            возникают, когда триггер в одной таблице вызывает
                            изменения в другой таблице, где, в свою очередь,
                            срабатывает другой триггер, который может повторно
                            затронуть первую таблицу
                        </p>
                    </section>
                    <section data-auto-animate>
                        <h1>Недостатки триггеров</h1>
                        <h3>
                            Триггеры не поддерживают транзакции между таблицами
                        </h3>
                        <p>
                            Если внутри триггера происходит ошибка, это может
                            привести к откату изменений только в одной таблице,
                            а не во всей транзакции
                        </p>
                    </section>
                    <section data-auto-animate>
                        <h1>Недостатки триггеров</h1>
                        <h3>Ограничения в стандартном SQL</h3>
                        <p>
                            Не все СУБД полностью поддерживают триггеры в
                            соответствии со стандартом SQL
                        </p>
                    </section>
                </section>
                <section>
                    <section>
                        <h1>Процедуры</h1>
                        <p>
                            сохранённый набор SQL-инструкций, которые
                            выполняются как единое целое
                        </p>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE PROCEDURE AddUser(IN username VARCHAR(50), IN email VARCHAR(100))
BEGIN
    INSERT INTO users (username, email) VALUES (username, email);
END;
                    </code></pre>
                    </section>
                    <section>
                        <h1>Преимущества процедур</h1>
                        <div class="grid grid-cols-2 gap-14">
                            <h4>Оптимизация повторного использования кода</h4>
                            <h4>Упрощение поддержки</h4>
                            <h4>Повышение безопасности</h4>
                            <h4>Оптимизация производительности</h4>
                        </div>
                    </section>
                    <section>
                        <h1>Синтаксис процедур</h1>
                        <h3><code class="sql">CREATE PROCEDURE</code></h3>
                        <p>
                            определяет тело процедуры, параметры и действия,
                            которые должны быть выполнены при вызове процедуры
                        </p>
                        <code class="sql">
                            CREATE PROCEDURE procedure_name (param1 datatype,
                            param2 datatype, ...)
                        </code>
                    </section>
                    <section>
                        <h1>Синтаксис процедур</h1>
                        <h3><code class="sql">Параметры процедуры</code></h3>
                        <p>
                            параметры, которые могут быть различного типа в
                            зависимости от назначения:
                        </p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border-b">
                                <h4>Входные параметры (IN)</h4>
                                <p>
                                    значения могут использоваться, но не
                                    изменяются внутри процедуры
                                </p>
                            </div>
                            <div class="border-b">
                                <h4>Выходные параметры (OUT)</h4>
                                <p>
                                    процедура может изменять их значения, и эти
                                    изменения будут доступны после вызова
                                    процедуры
                                </p>
                            </div>
                        </div>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE PROCEDURE GetUserEmail(IN user_id INT, OUT email VARCHAR(100))
BEGIN
    SELECT email INTO email FROM users WHERE id = user_id;
END;
                        </code></pre>
                    </section>
                    <section>
                        <h1>Синтаксис процедур</h1>
                        <h3><code class="sql">Параметры процедуры</code></h3>
                        <p>
                            параметры, которые могут быть различного типа в
                            зависимости от назначения:
                        </p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border-b col-span-2">
                                <h4>Входно-выходные параметры (INOUT)</h4>
                                <p>могут быть изменены внутри процедуры</p>
                            </div>
                        </div>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE PROCEDURE IncrementValue(INOUT value INT)
BEGIN
    SET value = value + 1;
END;
                        </code></pre>
                    </section>
                    <section>
                        <h1>Вызов процедур</h1>
                        <h3><code class="sql">CALL</code></h3>
                        <p>
                            можно передать необходимые параметры и запустить
                            выполнение процедуры
                        </p>
                        <code class="sql">
                            CALL procedure_name(param1, param2, ...);
                        </code>
                    </section>
                </section>
                <section>
                    <section>
                        <h1>Событие</h1>
                        <p>
                            задача, запланированная для выполнения в базе данных
                            в определённый момент времени или периодически
                        </p>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE EVENT delete_old_logs
ON SCHEDULE EVERY 1 DAY
DO
  DELETE FROM logs WHERE log_date &gt; NOW() - INTERVAL 30 DAY;
                        </code></pre>
                    </section>
                    <section>
                        <h1>Область применения событий</h1>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border-b">
                                Очистка устаревших данных
                            </div>
                            <div class="border-b">
                                Создание регулярных отчетов
                            </div>
                            <div class="border-b">Обновление данных</div>
                            <div class="border-b">Резервное копирование</div>
                        </div>
                    </section>
                    <section>
                        <h1>Синтаксис создания событий</h1>
                        <h4>
                            Оператор
                            <code>CREATE EVENT</code>
                        </h4>
                        <p>
                            позволяет задавать параметры, определяющие, когда и
                            какие действия должны быть выполнены
                        </p>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE EVENT event_name
ON SCHEDULE schedule_expression
DO
  sql_statement;
                        </code></pre>
                        <p>
                            Где
                            <code>event_name</code>
                            — имя события,
                            <code>schedule_expression</code>
                            — определяет, когда событие будет выполняться,
                            <code>sql_statement</code>
                            — SQL-команда или блок команд
                        </p>
                    </section>
                    <section>
                        <h4>Основные параметры</h4>
                        <p>
                            <code>ON SCHEDULE</code>
                            - указывает расписание выполнения события
                        </p>
                        <h5>
                            Возможные параметры для
                            <code>ON SCHEDULE</code>
                        </h5>
                        <ul>
                            <li>
                                <code>AT</code>
                                указывает конкретное время выполнения
                            </li>
                            <li>
                                <code>EVERY</code>
                                указывает периодичность выполнения
                            </li>
                            <li>
                                <code>DO</code>
                                указывается SQL-команда или процедуры,
                                которые должны быть выполнены, когда событие
                                срабатывает
                            </li>
                        </ul>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE EVENT daily_backup
ON SCHEDULE EVERY 1 DAY
DO
  CALL backup_procedure();
                        </code></pre>
                    </section>
                    <section>
                        <h1>Управление событиями</h1>
                        <h4>Просмотр событий</h4>
                        <code class="sql">SHOW EVENTS;</code>
                        <p>возвращает список всех событий в текущей базе данных, включая их названия, расписания и состояние</p>
                    </section>
                </section>
                <section>
                    <section>
                        <h1>Хранимые функции</h1>
                        <p>
                            подпрограмма, которая хранится и выполняется на
                            сервере базы данных
                        </p>
                        <div class="border-b">
                            <h4>Цель хранимой функции</h4>
                            <p>
                                возвращать одно значение на основе входных
                                параметров и логики, прописанной внутри функции
                            </p>
                        </div>
                        <pre><code data-trim data-noescape data-line-numbers class="sql">
CREATE FUNCTION function_name (parameter1 data_type, parameter2 data_type, ...)
RETURNS return_data_type
BEGIN
    -- тело функции
    RETURN result;
END;
                        </code></pre>
                    </section>
                    <section>
                        <h1>Различия между процедурой и функцией</h1>
                        <ul>
                            <li>Функция обязательно возвращает значение</li>
                            <li>Функции можно использовать в SQL-запросах</li>
                        </ul>
                    </section>
                    <section>
                        <h1>Область применения функций</h1>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border-b">
                                Для вычисления агрегированных значений
                            </div>
                            <div class="border-b">
                                Для обработки строк и чисел
                            </div>
                            <div class="border-b">
                                Для проверки условий и выполнения сложных
                                вычислений
                            </div>
                            <div class="border-b">
                                Для создания логики, которая может быть
                                использована в разных частях приложения
                            </div>
                        </div>
                    </section>
                    <section>
                        <h1>Создание хранимых функций</h1>
                    </section>
                </section>
            </div>
        </div>

        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script src="plugin/qrcode/qrcode.js"></script>
        <script src="plugin/mermaid/mermaid.js"></script>
        <script src="plugin/chalkboard/plugin.js"></script>
        <script src="plugin/customcontrols/plugin.js"></script>

        <script>
            tailwind.config = {
                corePlugins: {
                    preflight: false,
                },
            }
        </script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/

            const colors = {
                blue0: 'rgb(61, 89, 161)',
                blue: 'rgb(122, 162, 247)',
                cyan: 'rgb(125, 207, 255)',
                magenta: 'rgb(187, 154, 247)',
                orange: 'rgb(255, 158, 100)',
                yellow: 'rgb(224, 175, 104)',
                green: 'rgb(158, 206, 106)',
                teal: 'rgb(26, 188, 156)',
                red: 'rgb(255, 117, 127)',
                red1: 'rgb(219, 75, 75)',
                fg: 'rgb(192, 202, 245)',
                bg: 'rgb(26, 27, 38)',
                transparent: '#00000000',
            }

            Reveal.initialize({
                hash: true,
                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [
                    RevealMarkdown,
                    RevealHighlight,
                    RevealNotes,
                    RevealMermaid,
                    RevealChalkboard,
                    RevealCustomControls,
                ],
                slideNumber: true,
                customcontrols: {
                    controls: [
                        {
                            icon: '<div></div>',
                            title: 'Clear canvas (DEL)',
                            action: 'RevealChalkboard.clear();',
                        },
                        {
                            icon: '<div></div>',
                            title: 'Toggle chalkboard (B)',
                            action: 'RevealChalkboard.toggleChalkboard();',
                        },
                        {
                            icon: '<div></div>',
                            title: 'Toggle notes canvas (C)',
                            action: 'RevealChalkboard.toggleNotesCanvas();',
                        },
                    ],
                },
                chalkboard: {
                    boardmarkerWidth: 5,
                    boardmarkers: [
                        {
                            color: colors.bg,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.fg,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.blue,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.red,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.green,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.yellow,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.teal,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                        {
                            color: colors.orange,
                            cursor:
                                'url(' +
                                path +
                                'img/boardmarker-black.png), auto',
                        },
                    ],
                    chalks: [
                        {
                            color: colors.bg,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.fg,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.blue,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.red,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.green,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.yellow,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.teal,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                        {
                            color: colors.orange,
                            cursor:
                                'url(' + path + 'img/chalk-white.png), auto',
                        },
                    ],
                },
                mermaid: {
                    securityLevel: 'loose',
                    theme: 'dark',
                    themeVariables: {
                        darkMode: true,
                        textColor: colors.fg,
                        background: colors.bg,
                        mainBkg: colors.bg,
                        lineColor: colors.fg,
                    },
                },
            })
        </script>
    </body>
</html>
